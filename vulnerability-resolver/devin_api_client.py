import os
import time
import requests
from typing import Dict, Any, Optional, List


class DevinAPIClient:
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key or os.environ.get('DEVIN_API_KEY')
        if not self.api_key:
            raise ValueError("DEVIN_API_KEY not found in environment variables")
        
        self.base_url = "https://api.devin.ai/v1"
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
    
    def create_session(self, repo_url: str, prompt: str, 
                      branch: Optional[str] = None) -> Optional[str]:
        endpoint = f"{self.base_url}/sessions"
        
        payload = {
            "repo_url": repo_url,
            "prompt": prompt
        }
        
        if branch:
            payload["branch"] = branch
        
        try:
            response = requests.post(endpoint, json=payload, headers=self.headers, timeout=30)
            response.raise_for_status()
            
            data = response.json()
            session_id = data.get('session_id')
            
            if session_id:
                print(f"Created Devin session: {session_id}")
                return session_id
            else:
                print(f"Failed to create session: No session_id in response")
                return None
                
        except requests.exceptions.RequestException as e:
            print(f"Error creating Devin session: {e}")
            if hasattr(e, 'response') and e.response is not None:
                print(f"Response: {e.response.text}")
            return None
    
    def get_session_status(self, session_id: str) -> Optional[Dict[str, Any]]:
        endpoint = f"{self.base_url}/sessions/{session_id}"
        
        try:
            response = requests.get(endpoint, headers=self.headers, timeout=30)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error getting session status: {e}")
            return None
    
    def wait_for_completion(self, session_id: str, 
                           max_wait_seconds: int = 3600,
                           poll_interval: int = 30) -> Optional[Dict[str, Any]]:
        start_time = time.time()
        
        print(f"Waiting for session {session_id} to complete...")
        
        while time.time() - start_time < max_wait_seconds:
            status_data = self.get_session_status(session_id)
            
            if not status_data:
                print("Failed to get session status")
                return None
            
            status = status_data.get('status')
            print(f"Session status: {status}")
            
            if status in ['completed', 'success']:
                print(f"Session completed successfully")
                return status_data
            elif status in ['failed', 'error', 'cancelled']:
                print(f"Session ended with status: {status}")
                return status_data
            
            time.sleep(poll_interval)
        
        print(f"Timeout waiting for session to complete after {max_wait_seconds}s")
        return None
    
    def extract_pr_url(self, session_data: Dict[str, Any]) -> Optional[str]:
        if not session_data:
            return None
        
        pr_url = session_data.get('pr_url')
        if pr_url:
            return pr_url
        
        output = session_data.get('output', '')
        if 'github.com' in output and '/pull/' in output:
            import re
            match = re.search(r'https://github\.com/[^/]+/[^/]+/pull/\d+', output)
            if match:
                return match.group(0)
        
        return None
    
    def create_vulnerability_fix_session(self, repo_url: str, 
                                        batch: Dict[str, Any],
                                        branch: Optional[str] = None) -> Optional[str]:
        prompt = self._build_prompt(batch)
        return self.create_session(repo_url, prompt, branch)
    
    def _build_prompt(self, batch: Dict[str, Any]) -> str:
        pr_title = batch.get('pr_title', 'Fix CodeQL vulnerabilities')
        vulnerabilities = batch.get('vulnerabilities', [])
        
        prompt_parts = [
            f"# Task: {pr_title}",
            "",
            "Please fix the following security vulnerabilities identified by CodeQL:",
            ""
        ]
        
        for i, vuln in enumerate(vulnerabilities, 1):
            file_path = vuln.get('file_path', 'unknown')
            line_number = vuln.get('line_number', 0)
            rule_name = vuln.get('rule_name', vuln.get('rule_id', 'unknown'))
            message = vuln.get('message', 'No description')
            severity = vuln.get('severity', 'unknown')
            
            prompt_parts.append(f"{i}. **{rule_name}** ({severity} severity)")
            prompt_parts.append(f"   - Location: `{file_path}:{line_number}`")
            prompt_parts.append(f"   - Issue: {message}")
            prompt_parts.append("")
        
        prompt_parts.extend([
            "## Requirements:",
            "- Fix all listed vulnerabilities",
            "- Ensure fixes follow security best practices",
            "- Maintain existing functionality",
            "- Run any available tests to verify fixes",
            "- Create a PR with the changes",
            "",
            f"## PR Title:",
            f"{pr_title}",
            "",
            "Please proceed with fixing these issues and creating a PR."
        ])
        
        return "\n".join(prompt_parts)


def test_api_connection(api_key: Optional[str] = None) -> bool:
    try:
        client = DevinAPIClient(api_key)
        print("Successfully initialized Devin API client")
        return True
    except ValueError as e:
        print(f"Failed to initialize client: {e}")
        return False


if __name__ == "__main__":
    import sys
    
    if test_api_connection():
        print("Devin API client is ready")
    else:
        print("Failed to initialize Devin API client")
        sys.exit(1)
